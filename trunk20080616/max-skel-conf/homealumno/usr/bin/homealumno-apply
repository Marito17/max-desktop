#!/bin/bash

USERS=""

[ -f /etc/homealumno/config ] && . /etc/homealumno/config

# ver si users esta vacio
if [ "x${USERS}" = "x" ] || [ ! $USER ]; then
  exit 0
fi

# miramos si el usuario actual esta en la lista de usuarios a limpiar
USER_FOUND=
for user in $USERS; do
  if [ "$user" = "$USER" ]; then
    USER_FOUND=1
  fi
done

if [ ! $USER_FOUND ]; then
  exit 0
fi

echo "homealumno::usuario $USER limpieza... "

# ejecutamos el comando prelimpieza
if [ $PRECLEAN ] && [ -f $PRECLEAN ]; then
  . $PRECLEAN
fi

# copiamos primero del skel comun
rsync -avz --exclude-from=$EXCLUDE /etc/skel/ --delete $HOME/

# luego a√±adimos sin borrar lo anterior el skel del alumno
rsync -avz --exclude-from=$EXCLUDE $SKEL/ $HOME/


# ejecutamos el comando postlimpieza
if [ $PRECLEAN ] && [ -f $POSTCLEAN ]; then
  . $POSTCLEAN
fi

# permisos
chown -R $USER $HOME/

exit 0
